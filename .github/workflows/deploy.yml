name: Deploy

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    name: deploy
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v4

      # Build frontend
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - run: cd frontend && npm ci && npm run build

      # Build backend for linux
      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"
          cache-dependency-path: backend/go.sum
      - run: cd backend && GOOS=linux GOARCH=amd64 go build -o ../dist/server ./cmd/server

      # Deploy to Droplet
      # TODO: Replace with real deployment once Droplet is provisioned.
      # Options:
      #   - SCP artifacts + SSH restart
      #   - Docker image push to DO Container Registry
      #   - doctl app update (if using App Platform)
      - name: Deploy placeholder
        run: echo "Deployment will be configured after infrastructure is provisioned (issue #2)"
